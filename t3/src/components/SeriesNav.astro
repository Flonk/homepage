---
import { getCollection } from 'astro:content';
import SeriesNavClient from './SeriesNavClient.astro';

interface Props {
  seriesName: string;
  currentPart: string;
  prevPart?: string;
  nextPart?: string;
  position?: 'header' | 'footer';
}

const { seriesName, currentPart, prevPart, nextPart, position = 'header' } = Astro.props;

const allPosts = await getCollection('blog');

// Find the previous and next posts by part number within the same series
const titlePrefix = 'Type Systems #';
const seriesPosts = allPosts.filter(
  (p) => typeof p.data.title === 'string' && p.data.title.startsWith(titlePrefix),
);

const getPartLabel = (title: string) => {
  const match = title.match(/^Type Systems #(.*?):/);
  return match ? match[1].trim() : null;
};

const prevPost =
	prevPart != null
		? seriesPosts.find((p) => getPartLabel(p.data.title as string) === prevPart)
		: null;
const nextPost =
	nextPart != null
		? seriesPosts.find((p) => getPartLabel(p.data.title as string) === nextPart)
		: null;

const prevHref = prevPost ? `/blog/${prevPost.id}/` : undefined;
const prevDate = prevPost ? (prevPost.data.pubDate as Date).valueOf() : undefined;
const nextHref = nextPost ? `/blog/${nextPost.id}/` : undefined;
const nextDate = nextPost ? (nextPost.data.pubDate as Date).valueOf() : undefined;
---
<SeriesNavClient
	client:load
	currentPart={currentPart}
	prevPart={prevPart}
	nextPart={nextPart}
	position={position}
	prevHref={prevHref}
	prevDate={prevDate}
	nextHref={nextHref}
	nextDate={nextDate}
/>

